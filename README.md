[![GitHub release (latest SemVer)](https://img.shields.io/github/v/release/halvardssm/deno-nessie?label=Nessie%20stable&style=flat-square&logo=data:image/png;base64,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)](https://deno.land/x/nessie)
[![(Deno)](https://img.shields.io/badge/deno-v1.1.3-green.svg?style=flat-square&logo=deno)](https://deno.land)
[![GitHub Workflow Status (branch)](https://img.shields.io/github/workflow/status/halvardssm/deno-nessie/ci/master?style=flat-square&logo=github)](https://github.com/halvardssm/deno-nessie/actions?query=branch%3Amaster+workflow%3ACI)
[![(query-builder)](https://img.shields.io/badge/query_builder-doc-informational.svg?style=flat-square&logo=data:image/png;base64,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)](https://doc.deno.land/https/deno.land/x/nessie/qb.ts)
[![(clients)](https://img.shields.io/badge/clients-doc-informational.svg?style=flat-square&logo=data:image/png;base64,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)](https://doc.deno.land/https/deno.land/x/nessie/mod.ts)

# Nessie

<p align="center"><img src="./.github/logo.png" alt="Nessie logo" width="200" height="200"></p>

A modular database migration tool for [Deno](https://deno.land) inspired by [Laravel](https://github.com/laravel/laravel). Currently supports PostgreSQL, MySQL and SQLite.

If you would like to see your DB flavor supported, take a look at how to make a client plugin with examples in the [clients folder](./clients) or in the section [How to make a client](#how-to-make-a-client).

See documentation for the [query builder](https://doc.deno.land/https/deno.land/x/nessie/qb.ts).

See documentation for the [clients](https://doc.deno.land/https/deno.land/x/nessie/mod.ts).

## Usage

* `init`: Generates a `nessie.config.ts` file

  ```deno run --allow-net --allow-read --allow-write https://deno.land/x/nessie/cli.ts init```

* `make [name]`: Create migration

  ```deno run --allow-net --allow-read --allow-write https://deno.land/x/nessie/cli.ts make create_users```

* `make:seed [name]`: Create seed

  ```deno run --allow-net --allow-read --allow-write https://deno.land/x/nessie/cli.ts make:seed create_users```

* `migrate [amount?]`: Run migration - will migrate your migrations in your migration folder (sorted by timestamp) newer than the latest migration in your db. Amount defines how many migrations, defaults to all available if not set.

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts migrate```
  
  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts migrate 1```

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts migrate -c ./nessie.config.ts```

* `rollback [amount?]`: Rollback - will rollback your migrations. Amount defines how many migrations, defaults to 1 if not set.

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts rollback```
  
  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts rollback 2```

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts rollback all```

* `seed [matcher?]`: Seed - will seed your database. Optional matcher will match all files in your seed folder by string literal or RegExp.

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts seed```
  
  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts seed seed_file.js```

  ```deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts seed ".+.ts"```

### Flags

* `-c, --config`: Path to config file, will default to ./nessie.config.ts
* `-d, --debug`: Enables verbose output

## Contributing

All contributions are welcome, make sure to read the [contribution guideline](./.github/CONTRIBUTING.md).

## Uses

* [Denomander](https://deno.land/x/denomander/)
* [Deno Postgres](https://deno.land/x/postgres/)
* [Deno MySQL](https://deno.land/x/mysql/) - Currently it works with password for 5.*, but for >=8 you have to send a blank password, see [issue 37](https://github.com/manyuanrong/deno_mysql/issues/37)
* [Deno SQLite](https://deno.land/x/sqlite/)

## Examples

`nessie.config.ts` with all default values

```ts
import { ClientPostgreSQL } from "./clients/ClientPostgreSQL.ts";

const nessieOptions = {
  migrationFolder: "./db/migrations",
  seedFolder: "./db/seeds",
};

const connectionOptions = {
  database: "nessie",
  hostname: "localhost",
  port: 5432,
  user: "root",
  password: "pwd",
};

export default {
  client: new ClientPostgreSQL(nessieOptions, connectionOptions),
  exposeQueryBuilder: false,
};

```

Minimal example of a migration file

```ts
import { Migration } from "https://deno.land/x/nessie/mod.ts";

export const up: Migration = () => {
  return "CREATE TABLE table1 (id int);";
};

export const down: Migration = () => {
  return "DROP TABLE table1";
};
```

Using the native query builder (`exposeQueryBuilder: true`)

```ts
import { Migration } from "https://deno.land/x/nessie/mod.ts";
import { Schema } from "https://deno.land/x/nessie/qb.ts";

export const up: Migration<Schema> = ({ queryBuilder }) => {
  queryBuilder.create("users", (table) => {
    table.id();
    table.string("name", 100).nullable();
    table.boolean("is_true").default("false");
    table.custom("custom_column int default 1");
    table.timestamps();
  });

  queryBuilder.queryString(
    "INSERT INTO users VALUES (DEFAULT, 'Deno', true, 2, DEFAULT, DEFAULT);",
  )
  
  return queryBuilder.query
};

export const down: Migration<Schema> = ({ queryBuilder }) => {
  return queryBuilder.drop("users");
};
```

Seed file

```ts
import { Seed } from "https://deno.land/x/nessie/mod.ts";

export const run: Seed = () => {
  return "INSERT INTO testTable VALUES (1)"
};
```

See the [example folder](./examples) for more

## How to make a client

A client needs to extend [AbstractClient](./clients/AbstractClient.ts) and implement the [ClientI interface](./clients/AbstractClient.ts).

`query`: Takes a query string or array of query strings and sends them of to the batabase for execution. Should return whatever the database responds.

`prepare`: Will be run when the migration or rollback commands are executed. This should create the connection, set up the `nessie_migrations` table and prepare the database for incoming migrations.

`migrate`: Takes a number as an optional input, will default to all files if not set. Will run `Math.min(amount, numberOfFiles)` migration files. Only handles the `up` method.

`rollback`: Takes a number as an optional input, will default to 1 if not set. Will run `Math.min(amount, numberOfFiles)` migration files. Only handles the `down` method.

`seed`: Takes an optional matcher as input. Matcher can be regex or string. Will seed the database. Handles the `run` method in seed files.

`close`: Will be the last method run before the program is finished. This should close the database connection.
